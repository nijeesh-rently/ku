#!/bin/bash

# check if ruby is installed
if ! command -v ruby &> /dev/null
then
    echo "Ruby could not be found. Please install Ruby and try again."
    exit
fi

# check if bundler is installed
if ! command -v bundle &> /dev/null
then
    echo "Bundler could not be found. Installing bundler..."
    gem install bundler
fi

# install gems
echo "Installing gems..."
bundle install

# create a new file called `ku` and add the shebang for ruby and that file should require the `run` file
RUBY_PATH=$(which ruby)
echo "#!$RUBY_PATH" > bin/ku
echo "# AUTOGENERATED FILE. DO NOT EDIT" >> bin/ku
echo "require_relative '../app'" >> bin/ku



# create symlink to the app to /usr/local/bin so it can be run from anywhere
echo "Creating symlink to /usr/local/bin/ku"
sudo chmod +x bin/ku
sudo ln -s -n -f "$(pwd)/bin/ku" /usr/local/bin/ku


# if zsh is installed, add the completions to the zsh completions directory
if command -v zsh &> /dev/null
then
    echo "Adding completions to zsh completions directory..."
    mkdir -p ~/.zsh/completions
    cp completions/ku-completions ~/.zsh/completions/_ku
else
    echo "Zsh could not be found. Completions will not be added."
fi

echo "If you want to merge your kubectl config files for different clusters, run 'ku context merge --help' for more information."

echo "Installation complete. Run 'ku' to start the app."